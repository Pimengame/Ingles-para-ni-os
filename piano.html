<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Estudio</title>
    <link rel="stylesheet" href="estilos.css">
</head>
<body>

    <a href="index.html" class="btn-volver">â¬… Volver al MenÃº</a>

    <h1>ğŸ¹ Piano Estudio</h1>
    <p>Â¡Graba tus canciones cantando!</p>

    <div class="mueble-piano">
        <div class="panel-control-piano">
            <button id="btn-grabar" class="btn-rec btn-grabar" title="Grabar">ğŸ”´</button>
            <button id="btn-detener" class="btn-rec btn-stop" title="Detener" style="display:none;">â¬›</button>
            <button id="btn-reproducir" class="btn-rec btn-play" title="Escuchar" style="display:none;">â–¶ï¸</button>
            <div id="estado-grabacion" style="color:white; align-self: center; font-weight:bold;">Toca una tecla para activar</div>
        </div>

        <div class="contenedor-teclas" id="miPiano"></div>
    </div>

    <script>
        // --- 1. CONFIGURACIÃ“N DE AUDIO ROBUSTA ---
        // Creamos el contexto, pero sabemos que puede nacer "dormido"
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const audioCtx = new AudioContext();
        
        // Nodo maestro para controlar el volumen general
        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.8; // Volumen al 80%
        masterGain.connect(audioCtx.destination); // Conectado a los parlantes

        // Nodo especial para la grabadora
        const destinoGrabacion = audioCtx.createMediaStreamDestination();

        // Variables de GrabaciÃ³n
        let mediaRecorder;
        let chunks = [];
        let audioUrl;
        let grabacionAudio = new Audio();
        let grabando = false;

        const pianoContainer = document.getElementById('miPiano');

        // --- 2. EL DESPERTADOR DE AUDIO (FIX) ---
        // Esta funciÃ³n revisa si el audio estÃ¡ "Suspendido" y lo despierta
        function despertarAudio() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume().then(() => {
                    console.log("Audio despertado exitosamente");
                    document.getElementById('estado-grabacion').innerText = "Listo para tocar";
                });
            }
        }

        // --- 3. NOTAS Y FRECUENCIAS ---
        const notas = [
            { nota: "Do", tipo: "b", freq: 130.81 }, { nota: "Do#", tipo: "n", freq: 138.59 },
            { nota: "Re", tipo: "b", freq: 146.83 }, { nota: "Re#", tipo: "n", freq: 155.56 },
            { nota: "Mi", tipo: "b", freq: 164.81 }, { nota: "Fa", tipo: "b", freq: 174.61 },
            { nota: "Fa#", tipo: "n", freq: 185.00 }, { nota: "Sol", tipo: "b", freq: 196.00 },
            { nota: "Sol#", tipo: "n", freq: 207.65 }, { nota: "La", tipo: "b", freq: 220.00 },
            { nota: "La#", tipo: "n", freq: 233.08 }, { nota: "Si", tipo: "b", freq: 246.94 },
            
            { nota: "Do", tipo: "b", freq: 261.63 }, { nota: "Do#", tipo: "n", freq: 277.18 },
            { nota: "Re", tipo: "b", freq: 293.66 }, { nota: "Re#", tipo: "n", freq: 311.13 },
            { nota: "Mi", tipo: "b", freq: 329.63 }, { nota: "Fa", tipo: "b", freq: 349.23 },
            { nota: "Fa#", tipo: "n", freq: 369.99 }, { nota: "Sol", tipo: "b", freq: 392.00 },
            { nota: "Sol#", tipo: "n", freq: 415.30 }, { nota: "La", tipo: "b", freq: 440.00 },
            { nota: "La#", tipo: "n", freq: 466.16 }, { nota: "Si", tipo: "b", freq: 493.88 },

            { nota: "Do", tipo: "b", freq: 523.25 }, { nota: "Do#", tipo: "n", freq: 554.37 },
            { nota: "Re", tipo: "b", freq: 587.33 }, { nota: "Re#", tipo: "n", freq: 622.25 },
            { nota: "Mi", tipo: "b", freq: 659.25 }, { nota: "Fa", tipo: "b", freq: 698.46 }
        ];

        // --- 4. DIBUJAR TECLAS ---
        let blancasCount = 0;
        const anchoBlanca = 62;
        const anchoNegra = 38;

        notas.forEach(item => {
            const tecla = document.createElement('div');
            
            if (item.tipo === 'b') {
                tecla.className = 'tecla-blanca';
                tecla.innerText = item.nota;
                pianoContainer.appendChild(tecla);
                asignarEventos(tecla, item.freq);
                blancasCount++;
            } else {
                tecla.className = 'tecla-negra';
                const leftPos = (blancasCount * anchoBlanca) - (anchoNegra / 2) - 2; 
                tecla.style.left = leftPos + 'px';
                pianoContainer.appendChild(tecla);
                asignarEventos(tecla, item.freq);
            }
        });

        // --- 5. MOTOR DE SONIDO (MEJORADO) ---
        function tocarNota(frecuencia, elemento) {
            despertarAudio(); // Â¡IMPORTANTE! Intenta despertar en cada toque

            if(elemento.classList.contains('activa')) return;
            elemento.classList.add('activa');

            const osc = audioCtx.createOscillator();
            const noteGain = audioCtx.createGain();

            osc.type = 'triangle';
            osc.frequency.setValueAtTime(frecuencia, audioCtx.currentTime);

            // Envolvente de sonido (ADSR simple)
            noteGain.gain.setValueAtTime(0, audioCtx.currentTime);
            noteGain.gain.linearRampToValueAtTime(0.6, audioCtx.currentTime + 0.02);
            noteGain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1.5);

            // --- RUTEO DE CABLES ---
            // 1. Cable hacia el Master (Parlantes)
            noteGain.connect(masterGain);
            
            // 2. Cable hacia la Grabadora (Si estamos grabando)
            // Esto evita problemas de rendimiento si no se usa
            noteGain.connect(destinoGrabacion);

            osc.connect(noteGain);
            osc.start();
            osc.stop(audioCtx.currentTime + 1.5);
            elemento.oscilador = osc;
        }

        function soltarTecla(elemento) {
            setTimeout(() => elemento.classList.remove('activa'), 100);
            if (elemento.oscilador) {
                try { 
                    // Detener suavemente
                    elemento.oscilador.stop(audioCtx.currentTime + 0.1); 
                } catch(e) {}
            }
        }

        function asignarEventos(tecla, freq) {
            // Mouse
            tecla.addEventListener('mousedown', (e) => { 
                if(e.buttons === 1) tocarNota(freq, tecla); 
            });
            // TÃ¡ctil (Android)
            tecla.addEventListener('touchstart', (e) => { 
                e.preventDefault(); // Evita scroll y menÃºs raros
                tocarNota(freq, tecla); 
            });
            
            tecla.addEventListener('mouseup', () => soltarTecla(tecla));
            tecla.addEventListener('mouseleave', () => soltarTecla(tecla));
            tecla.addEventListener('touchend', () => soltarTecla(tecla));
        }

        // --- 6. GRABADORA (MICRÃ“FONO + PIANO) ---
        const btnGrabar = document.getElementById('btn-grabar');
        const btnDetener = document.getElementById('btn-detener');
        const btnPlay = document.getElementById('btn-reproducir');
        const txtEstado = document.getElementById('estado-grabacion');

// --- BUSCA ESTA PARTE EN TU CÃ“DIGO Y REEMPLÃZALA ---

        btnGrabar.onclick = async () => {
            despertarAudio(); 

            try {
                // AQUÃ ESTÃ EL TRUCO: ConfiguraciÃ³n "Pro" para mÃºsica
                // Desactivamos la cancelaciÃ³n de eco y supresiÃ³n de ruido
                // para que no corte la voz cuando suena el piano.
                const constraints = {
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        latency: 0
                    }
                };

                const streamMic = await navigator.mediaDevices.getUserMedia(constraints);
                const sourceMic = audioCtx.createMediaStreamSource(streamMic);
                
                // Conectar Micro a Grabadora
                sourceMic.connect(destinoGrabacion);

                // --- RESTO DEL CÃ“DIGO IGUAL QUE ANTES ---
                mediaRecorder = new MediaRecorder(destinoGrabacion.stream);
                chunks = [];

                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                    audioUrl = window.URL.createObjectURL(blob);
                    grabacionAudio.src = audioUrl;
                    
                    streamMic.getTracks().forEach(track => track.stop());
                    
                    btnPlay.style.display = 'inline-block';
                    txtEstado.innerText = "Â¡GrabaciÃ³n terminada!";
                    txtEstado.classList.remove('parpadeo');
                    grabando = false;
                };

                mediaRecorder.start();
                grabando = true;
                
                btnGrabar.style.display = 'none';
                btnDetener.style.display = 'inline-block';
                btnPlay.style.display = 'none';
                txtEstado.innerText = "ğŸ”´ GRABANDO... (Toca y Canta)";
                txtEstado.classList.add('parpadeo');

            } catch (err) {
                alert("Error al acceder al micrÃ³fono: " + err.message);
                console.error(err);
            }
        };

        btnDetener.onclick = () => {
            if(mediaRecorder && grabando) {
                mediaRecorder.stop();
                btnDetener.style.display = 'none';
                btnGrabar.style.display = 'inline-block';
            }
        };

        btnPlay.onclick = () => {
            txtEstado.innerText = "â–¶ï¸ Reproduciendo...";
            grabacionAudio.play();
            grabacionAudio.onended = () => txtEstado.innerText = "Listo para grabar de nuevo";
        };

    </script>
</body>
</html>

