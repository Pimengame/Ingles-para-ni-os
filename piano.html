<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Maestro Pro</title>
    <link rel="stylesheet" href="estilos.css">
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            overflow-x: hidden; /* Evita scroll lateral en toda la p√°gina */
        }

        /* --- BOTONES SUPERIORES --- */
        .header-botones {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .btn-volver {
            position: relative; /* Cambiado de fixed a relative para mejor control */
            top: auto; left: auto;
            margin: 0;
        }

        .btn-fullscreen {
            background: #263238;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
            border-bottom: 4px solid #000;
        }
        .btn-fullscreen:active { transform: translateY(4px); border-bottom-width: 0; }

        /* --- SELECTOR DE MODOS --- */
        .selector-modos {
            display: flex; justify-content: center; gap: 20px; 
            margin-top: 80px; /* Espacio para el header */
            margin-bottom: 25px;
        }
        .btn-modo {
            background: #fff; border: none; padding: 12px 25px; border-radius: 50px;
            font-family: 'Fredoka One', cursive; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 0 #ddd; transition: all 0.2s;
            opacity: 0.7; filter: grayscale(100%);
        }
        .btn-modo:active { transform: translateY(4px); box-shadow: none; }
        .btn-modo.activo {
            opacity: 1; filter: grayscale(0%); transform: scale(1.1);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 10;
        }
        #btn-modo-grabadora.activo { border: 2px solid #f44336; color: #d32f2f; }
        #btn-modo-clases.activo { border: 2px solid #2196f3; color: #1565c0; }

        /* --- PANELES --- */
        .panel-canciones {
            display: none; justify-content: center; gap: 10px; flex-wrap: wrap;
            margin-bottom: 15px; animation: bajar 0.5s ease; width: 100%;
        }
        @keyframes bajar { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }

        .btn-cancion {
            background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5);
            padding: 8px 15px; border-radius: 15px; cursor: pointer;
            font-family: 'Fredoka One', cursive; font-size: 1rem; transition: 0.2s;
        }
        .btn-cancion:hover { background: white; color: #3f51b5; }
        .btn-cancion.activa { background: #ff4081; border-color: white; color: white; transform: scale(1.05); }

        /* --- TECLAS GU√çA --- */
        .tecla-blanca.tecla-guia {
            background: #ffeb3b !important;
            box-shadow: 0 0 30px #ffeb3b, inset 0 -5px 10px rgba(0,0,0,0.1) !important;
            z-index: 50; animation: latido 1s infinite; border-color: #fdd835;
        }
        .tecla-negra.tecla-guia {
            background: #ffeb3b !important;
            box-shadow: 0 0 30px #ffeb3b !important;
            z-index: 100; animation: latido 1s infinite; border-bottom-color: #f9a825;
        }
        @keyframes latido { 0%{transform:scale(1);} 50%{transform:scale(1.02) translateY(2px);} 100%{transform:scale(1);} }

        /* --- MUEBLE PIANO MEJORADO --- */
        .mueble-piano {
            overflow: hidden; 
            padding: 0 0 20px 0; 
            position: relative;
            max-width: 100%; /* Asegura que no rompa el ancho en m√≥viles */
        }

        .tira-roja {
            height: 15px; background: #b71c1c; margin-bottom: 0; width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20; position: relative;
        }

        /* --- CONTENEDOR TECLAS CON SCROLL VISIBLE --- */
        .contenedor-teclas {
            display: flex;
            justify-content: center; /* Intenta centrar */
            overflow-x: auto; /* Scroll si no cabe */
            overflow-y: hidden;
            padding-bottom: 20px; /* Espacio para scrollbar */
            margin: 0 auto;
            background: rgba(0,0,0,0.2);
            border-top: 5px solid rgba(0,0,0,0.3);
            
            /* Scrollbar estilo moderno */
            scrollbar-width: thin;
            scrollbar-color: #29b6f6 transparent;
            -webkit-overflow-scrolling: touch; /* Suavidad en iPhone */
        }
        
        /* En pantallas peque√±as, alinear al inicio para facilitar scroll */
        @media (max-width: 900px) {
            .contenedor-teclas {
                justify-content: flex-start;
            }
        }

        /* Aviso de deslizamiento */
        .aviso-scroll {
            display: none;
            color: #666;
            font-size: 0.9rem;
            margin-top: -10px;
            margin-bottom: 10px;
            font-family: 'Varela Round';
            animation: flotarTexto 2s infinite;
        }
        @media (max-width: 800px) { .aviso-scroll { display: block; } }
        @keyframes flotarTexto { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }

    </style>
</head>
<body>

    <div class="header-botones">
        <a href="index.html" class="btn-volver">‚¨Ö Volver</a>
        <button class="btn-fullscreen" onclick="togglePantallaCompleta()" title="Pantalla Completa">‚õ∂</button>
    </div>

    <h1 style="margin-top: 10px;">üéπ Piano M√°gico</h1>

    <div class="selector-modos">
        <button id="btn-modo-grabadora" class="btn-modo activo" onclick="cambiarModo('grabadora')">
            üéôÔ∏è Estudio
        </button>
        <button id="btn-modo-clases" class="btn-modo" onclick="cambiarModo('clases')">
            üéì Escuela
        </button>
    </div>

    <div class="aviso-scroll">‚ÜîÔ∏è Desliza el piano para ver m√°s teclas ‚ÜîÔ∏è</div>

    <div class="mueble-piano">
        <div class="tira-roja"></div>

        <div id="panel-grabadora" class="panel-control-piano">
            <button id="btn-grabar" class="btn-rec btn-grabar" title="Grabar">üî¥</button>
            <button id="btn-detener" class="btn-rec btn-stop" title="Detener" style="display:none;">‚¨õ</button>
            <button id="btn-reproducir" class="btn-rec btn-play" title="Escuchar" style="display:none;">‚ñ∂Ô∏è</button>
            <div id="estado-grabacion" style="color:white; font-family:'Varela Round'; font-weight:bold; font-size:1.2rem;">
                ¬°Toca y Canta! üéµ
            </div>
        </div>

        <div id="panel-clases" class="panel-canciones">
            <div style="width: 100%; text-align: center; color: white; margin-bottom: 8px; font-family:'Varela Round'; opacity:0.8;">
                üëá Elige una canci√≥n:
            </div>
            <button class="btn-cancion" onclick="iniciarClase('estrellita', this)">üåü Estrellita</button>
            <button class="btn-cancion" onclick="iniciarClase('cumple', this)">üéÇ Cumplea√±os</button>
            <button class="btn-cancion" onclick="iniciarClase('himno', this)">üéº Alegr√≠a</button>
            <button class="btn-cancion" onclick="iniciarClase('tiburon', this)">ü¶à Tibur√≥n</button>
            <button class="btn-cancion" onclick="iniciarClase('recuerdame', this)">üé∏ Recu√©rdame</button>
            <button class="btn-cancion" onclick="iniciarClase('dragonball', this)">üêâ Dragon Ball</button>
            <button class="btn-cancion" onclick="iniciarClase('slamdunk', this)">üèÄ Slam Dunk</button>
            
            <div id="mensaje-clase" style="width: 100%; text-align: center; color: #ffeb3b; font-size: 1.4rem; margin-top: 10px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
        </div>

        <div class="contenedor-teclas" id="miPiano">
            </div>
    </div>

    <script src="motor.js"></script>

    <script>
        // ==========================================
        // 1. PANTALLA COMPLETA
        // ==========================================
        function togglePantallaCompleta() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // ==========================================
        // 2. CONFIGURACI√ìN DE AUDIO
        // ==========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const contextoPiano = new AudioContext();
        const masterGain = contextoPiano.createGain();
        masterGain.gain.value = 0.8;
        masterGain.connect(contextoPiano.destination);
        const destinoGrabacion = contextoPiano.createMediaStreamDestination();

        let mediaRecorder;
        let chunks = [];
        let grabacionAudio = new Audio();
        let grabando = false;
        let modoActual = 'grabadora';
        let cancionActual = [];
        let indiceNota = 0;
        let notaEsperada = null;

        // ==========================================
        // 3. DEFINICI√ìN DE NOTAS (2 OCTAVAS)
        // ==========================================
        const notas = [
            { id: "c3", nota: "Do", tipo: "b", freq: 130.81 }, { id: "cs3", nota: "", tipo: "n", freq: 138.59 },
            { id: "d3", nota: "Re", tipo: "b", freq: 146.83 }, { id: "ds3", nota: "", tipo: "n", freq: 155.56 },
            { id: "e3", nota: "Mi", tipo: "b", freq: 164.81 },
            { id: "f3", nota: "Fa", tipo: "b", freq: 174.61 }, { id: "fs3", nota: "", tipo: "n", freq: 185.00 },
            { id: "g3", nota: "Sol", tipo: "b", freq: 196.00 }, { id: "gs3", nota: "", tipo: "n", freq: 207.65 },
            { id: "a3", nota: "La", tipo: "b", freq: 220.00 }, { id: "as3", nota: "", tipo: "n", freq: 233.08 },
            { id: "b3", nota: "Si", tipo: "b", freq: 246.94 },

            { id: "c4", nota: "Do", tipo: "b", freq: 261.63 }, { id: "cs4", nota: "", tipo: "n", freq: 277.18 },
            { id: "d4", nota: "Re", tipo: "b", freq: 293.66 }, { id: "ds4", nota: "", tipo: "n", freq: 311.13 },
            { id: "e4", nota: "Mi", tipo: "b", freq: 329.63 },
            { id: "f4", nota: "Fa", tipo: "b", freq: 349.23 }, { id: "fs4", nota: "", tipo: "n", freq: 369.99 },
            { id: "g4", nota: "Sol", tipo: "b", freq: 392.00 }, { id: "gs4", nota: "", tipo: "n", freq: 415.30 },
            { id: "a4", nota: "La", tipo: "b", freq: 440.00 }, { id: "as4", nota: "", tipo: "n", freq: 466.16 },
            { id: "b4", nota: "Si", tipo: "b", freq: 493.88 },

            { id: "c5", nota: "Do", tipo: "b", freq: 523.25 }, { id: "cs5", nota: "", tipo: "n", freq: 554.37 },
            { id: "d5", nota: "Re", tipo: "b", freq: 587.33 }, { id: "ds5", nota: "", tipo: "n", freq: 622.25 },
            { id: "e5", nota: "Mi", tipo: "b", freq: 659.25 }
        ];

        const canciones = {
            'estrellita': ['c4','c4','g4','g4','a4','a4','g4','f4','f4','e4','e4','d4','d4','c4','g4','g4','f4','f4','e4','e4','d4','g4','g4','f4','f4','e4','e4','d4','c4','c4','g4','g4','a4','a4','g4','f4','f4','e4','e4','d4','d4','c4'],
            'cumple': ['c4','c4','d4','c4','f4','e4','c4','c4','d4','c4','g4','f4','c4','c4','c5','a4','f4','e4','d4','as4','as4','a4','f4','g4','f4'],
            'himno': ['e4','e4','f4','g4','g4','f4','e4','d4','c4','c4','d4','e4','e4','d4','d4','e4','e4','f4','g4','g4','f4','e4','d4','c4','c4','d4','e4','d4','c4','c4','d4','d4','e4','c4','d4','e4','f4','e4','c4','d4','e4','f4','e4','d4','c4','d4','g3'],
            'tiburon': ['d4','e4','g4','g4','g4','g4','g4','g4','d4','e4','g4','g4','g4','g4','g4','g4','d4','e4','g4','g4','g4','g4','g4','g4','g4','g4','f4'],
            'recuerdame': ['c4','e4','c4','c4','e4','c4','g3','e4','c4','e4','c4','e4','g4','f4','e4','d4','d4','e4','f4','e4','d4','c4','g3','a3','b3','c4','c4','c5','b4','a4','g4','f4','e4','f4','g4','f4','e4','d4','c4','e4','c4','c4','e4','c4','g3','e4','c4','e4','c4','e4','g4','f4','e4','d4','c4','c5','b4','c5','a4','a4','b4','a4','g4','f4','e4','f4','e4','f4','e4','d4','c4','c4','e4','c4'],
            'dragonball': ['g4','g4','e4','f4','g4','a4','g4','f4','e4','d4','e4','e4','c4','d4','e4','f4','e4','d4','c4','b3','a3','a3','a3','c4','a3','g3','c4','d4','e4','f4','e4','d4','c4','d4','c5','c5','c5','c5','c5','as4','gs4','as4','c5','as4','as4','as4','gs4','g4','g4','f4','f4','g4','ds4','f4','g4'],
            'slamdunk': ['f4','f4','g4','a4','a4','g4','f4','g4','a4','g4','f4','g4','a4','c5','c5','c5','c5','a4','as4','a4','f4','a4','as4','c5','d5','c5','as4','a4','g4','f4','g4','a4','a4','c5','d5','e5','f4','g4','a4','as4','a4','g4','f4']
        };

        const pianoContainer = document.getElementById('miPiano');
        let blancasCount = 0;
        const anchoBlanca = 60; 
        const anchoNegra = 40; 

        if (pianoContainer) {
            notas.forEach(item => {
                const tecla = document.createElement('div');
                tecla.id = 'tecla-' + item.id; 
                
                if (item.tipo === 'b') {
                    tecla.className = 'tecla-blanca';
                    tecla.innerText = item.nota;
                    pianoContainer.appendChild(tecla);
                    asignarEventos(tecla, item);
                    blancasCount++;
                } else {
                    tecla.className = 'tecla-negra';
                    const leftPos = (blancasCount * anchoBlanca) - (anchoNegra / 2); 
                    tecla.style.left = leftPos + 'px';
                    pianoContainer.appendChild(tecla);
                    asignarEventos(tecla, item);
                }
            });
            pianoContainer.style.width = (blancasCount * anchoBlanca) + 'px';
        }

        function tocarNota(item, elemento) {
            if (contextoPiano.state === 'suspended') contextoPiano.resume();
            
            if(elemento.classList.contains('activa')) return;
            elemento.classList.add('activa');

            const osc = contextoPiano.createOscillator();
            const noteGain = contextoPiano.createGain();

            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(item.freq, contextoPiano.currentTime);

            noteGain.gain.setValueAtTime(0, contextoPiano.currentTime);
            noteGain.gain.linearRampToValueAtTime(0.5, contextoPiano.currentTime + 0.02);
            noteGain.gain.exponentialRampToValueAtTime(0.001, contextoPiano.currentTime + 1.5);

            noteGain.connect(masterGain);
            noteGain.connect(destinoGrabacion); 

            osc.connect(noteGain);
            osc.start();
            osc.stop(contextoPiano.currentTime + 1.5);
            elemento.oscilador = osc;

            if (modoActual === 'clases' && notaEsperada) {
                if (item.id === notaEsperada) {
                    indiceNota++;
                    iluminarSiguienteNota();
                }
            }
        }

        function soltarTecla(elemento) {
            setTimeout(() => elemento.classList.remove('activa'), 150);
            if (elemento.oscilador) {
                try { elemento.oscilador.stop(contextoPiano.currentTime + 0.1); } catch(e) {}
            }
        }

        function asignarEventos(tecla, item) {
            const iniciar = (e) => { 
                if(e.type === 'mousedown' && e.buttons !== 1) return;
                tocarNota(item, tecla); 
            };
            const terminar = (e) => { soltarTecla(tecla); };

            tecla.addEventListener('mousedown', iniciar);
            tecla.addEventListener('touchstart', (e) => { e.preventDefault(); tocarNota(item, tecla); });
            tecla.addEventListener('mouseup', terminar);
            tecla.addEventListener('mouseleave', terminar);
            tecla.addEventListener('touchend', terminar);
        }

        function iniciarClase(nombreCancion, btn) {
            document.querySelectorAll('.btn-cancion').forEach(b => b.classList.remove('activa'));
            if(btn) btn.classList.add('activa');

            document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));
            cancionActual = canciones[nombreCancion];
            indiceNota = 0;
            document.getElementById('mensaje-clase').innerText = "¬°Sigue la tecla amarilla!";
            
            centrarPianoEnDoCentral();
            iluminarSiguienteNota();
        }

        function iluminarSiguienteNota() {
            document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));

            if (indiceNota < cancionActual.length) {
                notaEsperada = cancionActual[indiceNota];
                const tecla = document.getElementById('tecla-' + notaEsperada);
                
                if (tecla) {
                    tecla.classList.add('tecla-guia');
                }
            } else {
                notaEsperada = null;
                document.getElementById('mensaje-clase').innerHTML = "¬°FELICIDADES! üéâ";
                if(typeof lanzarConfeti === 'function') lanzarConfeti();
                if(typeof playSound === 'function') playSound('fanfarria');
                setTimeout(() => {
                    if(typeof mostrarModal === 'function') mostrarModal('victoria');
                }, 1000);
            }
        }

        function cambiarModo(modo) {
            modoActual = modo;
            document.getElementById('btn-modo-grabadora').classList.toggle('activo', modo === 'grabadora');
            document.getElementById('btn-modo-clases').classList.toggle('activo', modo === 'clases');
            const pGrab = document.getElementById('panel-grabadora');
            const pClas = document.getElementById('panel-clases');

            if (modo === 'grabadora') {
                pGrab.style.display = 'flex'; pClas.style.display = 'none';
                document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));
                notaEsperada = null;
            } else {
                pGrab.style.display = 'none'; pClas.style.display = 'flex';
                document.getElementById('mensaje-clase').innerText = "Selecciona una canci√≥n";
                centrarPianoEnDoCentral();
            }
            if(typeof playSound === 'function') playSound('click');
        }

        function centrarPianoEnDoCentral() {
            const doCentral = document.getElementById('tecla-c4');
            if(doCentral) {
                doCentral.scrollIntoView({behavior: "smooth", block: "nearest", inline: "center"});
            }
        }

        window.addEventListener('load', () => {
             setTimeout(centrarPianoEnDoCentral, 500);
        });

        const btnGrabar = document.getElementById('btn-grabar');
        const btnDetener = document.getElementById('btn-detener');
        const btnPlay = document.getElementById('btn-reproducir');
        const txtEstado = document.getElementById('estado-grabacion');

        btnGrabar.onclick = async () => {
            if (contextoPiano.state === 'suspended') contextoPiano.resume();
            try {
                const streamMic = await navigator.mediaDevices.getUserMedia({audio: true});
                const sourceMic = contextoPiano.createMediaStreamSource(streamMic);
                sourceMic.connect(destinoGrabacion);
                mediaRecorder = new MediaRecorder(destinoGrabacion.stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                    grabacionAudio.src = window.URL.createObjectURL(blob);
                    streamMic.getTracks().forEach(track => track.stop());
                    btnPlay.style.display = 'inline-block'; txtEstado.innerText = "¬°Grabado! üé§";
                    grabando = false;
                };
                mediaRecorder.start(); grabando = true;
                btnGrabar.style.display = 'none'; btnDetener.style.display = 'inline-block'; btnPlay.style.display = 'none';
                txtEstado.innerText = "üî¥ Grabando...";
            } catch (err) { alert("Necesito micr√≥fono para grabar."); }
        };
        btnDetener.onclick = () => { if(mediaRecorder && grabando) { mediaRecorder.stop(); btnDetener.style.display = 'none'; btnGrabar.style.display = 'inline-block'; } };
        btnPlay.onclick = () => { txtEstado.innerText = "‚ñ∂Ô∏è Reproduciendo..."; grabacionAudio.play(); grabacionAudio.onended = () => txtEstado.innerText = "¬°Grabado! üé§"; };

    </script>
</body>
</html>
