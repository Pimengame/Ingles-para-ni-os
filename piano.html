<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Estudio</title>
    <link rel="stylesheet" href="estilos.css">
</head>
<body>

    <a href="index.html" class="btn-volver">â¬… Volver al MenÃº</a>

    <h1>ğŸ¹ Piano Estudio</h1>
    <p>Â¡Graba tus canciones cantando!</p>

    <div class="mueble-piano">
        
        <div class="panel-control-piano">
            <button id="btn-grabar" class="btn-rec btn-grabar" title="Grabar">ğŸ”´</button>
            <button id="btn-detener" class="btn-rec btn-stop" title="Detener" style="display:none;">â¬›</button>
            <button id="btn-reproducir" class="btn-rec btn-play" title="Escuchar" style="display:none;">â–¶ï¸</button>
            <div id="estado-grabacion" style="color:white; align-self: center; font-weight:bold;">Listo para grabar</div>
        </div>

        <div class="contenedor-teclas" id="miPiano"></div>
    </div>

    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const pianoContainer = document.getElementById('miPiano');

        // Variables de GrabaciÃ³n
        let mediaRecorder;
        let chunks = [];
        let audioBlob;
        let audioUrl;
        let grabacionAudio = new Audio();
        
        // NODO DE DESTINO (AquÃ­ mezclamos piano + voz para grabar)
        const destinoGrabacion = audioCtx.createMediaStreamDestination();

        // --- 1. CONFIGURACIÃ“N DEL PIANO (Escalas y Notas) ---
        const notas = [
            { nota: "Do", tipo: "b", freq: 130.81 }, { nota: "Do#", tipo: "n", freq: 138.59 },
            { nota: "Re", tipo: "b", freq: 146.83 }, { nota: "Re#", tipo: "n", freq: 155.56 },
            { nota: "Mi", tipo: "b", freq: 164.81 }, { nota: "Fa", tipo: "b", freq: 174.61 },
            { nota: "Fa#", tipo: "n", freq: 185.00 }, { nota: "Sol", tipo: "b", freq: 196.00 },
            { nota: "Sol#", tipo: "n", freq: 207.65 }, { nota: "La", tipo: "b", freq: 220.00 },
            { nota: "La#", tipo: "n", freq: 233.08 }, { nota: "Si", tipo: "b", freq: 246.94 },
            
            { nota: "Do", tipo: "b", freq: 261.63 }, { nota: "Do#", tipo: "n", freq: 277.18 },
            { nota: "Re", tipo: "b", freq: 293.66 }, { nota: "Re#", tipo: "n", freq: 311.13 },
            { nota: "Mi", tipo: "b", freq: 329.63 }, { nota: "Fa", tipo: "b", freq: 349.23 },
            { nota: "Fa#", tipo: "n", freq: 369.99 }, { nota: "Sol", tipo: "b", freq: 392.00 },
            { nota: "Sol#", tipo: "n", freq: 415.30 }, { nota: "La", tipo: "b", freq: 440.00 },
            { nota: "La#", tipo: "n", freq: 466.16 }, { nota: "Si", tipo: "b", freq: 493.88 },

            { nota: "Do", tipo: "b", freq: 523.25 }, { nota: "Do#", tipo: "n", freq: 554.37 },
            { nota: "Re", tipo: "b", freq: 587.33 }, { nota: "Re#", tipo: "n", freq: 622.25 },
            { nota: "Mi", tipo: "b", freq: 659.25 }, { nota: "Fa", tipo: "b", freq: 698.46 }
        ];

        // --- 2. DIBUJAR TECLAS (LÃ³gica visual corregida) ---
        let blancasCount = 0;
        const anchoBlanca = 62; // 60px ancho + 2px margen
        const anchoNegra = 38;

        notas.forEach(item => {
            const tecla = document.createElement('div');
            
            if (item.tipo === 'b') {
                tecla.className = 'tecla-blanca';
                tecla.innerText = item.nota;
                pianoContainer.appendChild(tecla);
                asignarEventos(tecla, item.freq);
                blancasCount++;
            } else {
                tecla.className = 'tecla-negra';
                // CÃ¡lculo de posiciÃ³n: (Teclas Blancas Anteriores * Ancho) - (Mitad de Negra)
                // Ajuste fino: -4px para centrar visualmente
                const leftPos = (blancasCount * anchoBlanca) - (anchoNegra / 2) - 2; 
                tecla.style.left = leftPos + 'px';
                pianoContainer.appendChild(tecla);
                asignarEventos(tecla, item.freq);
            }
        });

        // --- 3. MOTOR DE SONIDO (ConexiÃ³n a Grabadora) ---
        function tocarNota(frecuencia, elemento) {
            if(elemento.classList.contains('activa')) return;
            elemento.classList.add('activa');

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = 'triangle';
            osc.frequency.setValueAtTime(frecuencia, audioCtx.currentTime);

            gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 2.0);

            // CONEXIÃ“N DOBLE:
            // 1. A los parlantes (para que escuches)
            gainNode.connect(audioCtx.destination);
            // 2. A la grabadora (si estÃ¡ grabando)
            gainNode.connect(destinoGrabacion);

            osc.start();
            osc.stop(audioCtx.currentTime + 2.0);
            elemento.oscilador = osc;
        }

        function soltarTecla(elemento) {
            setTimeout(() => elemento.classList.remove('activa'), 100);
            if (elemento.oscilador) {
                try { elemento.oscilador.stop(audioCtx.currentTime + 0.1); } catch(e) {}
            }
        }

        function asignarEventos(tecla, freq) {
            tecla.addEventListener('mousedown', () => tocarNota(freq, tecla));
            tecla.addEventListener('mouseup', () => soltarTecla(tecla));
            tecla.addEventListener('mouseleave', () => soltarTecla(tecla));
            tecla.addEventListener('touchstart', (e) => { e.preventDefault(); tocarNota(freq, tecla); });
            tecla.addEventListener('touchend', () => soltarTecla(tecla));
        }

        // --- 4. SISTEMA DE GRABACIÃ“N (PIANO + VOZ) ---
        const btnGrabar = document.getElementById('btn-grabar');
        const btnDetener = document.getElementById('btn-detener');
        const btnPlay = document.getElementById('btn-reproducir');
        const txtEstado = document.getElementById('estado-grabacion');

        btnGrabar.onclick = async () => {
            // Activar AudioContext si estaba suspendido
            if (audioCtx.state === 'suspended') await audioCtx.resume();

            // Pedir permiso para MicrÃ³fono
            try {
                const streamMic = await navigator.mediaDevices.getUserMedia({ audio: true });
                const sourceMic = audioCtx.createMediaStreamSource(streamMic);
                
                // Conectar MicrÃ³fono SOLO a la grabadora (no a parlantes para evitar acople/chillido)
                sourceMic.connect(destinoGrabacion);

                // Iniciar Grabadora
                mediaRecorder = new MediaRecorder(destinoGrabacion.stream);
                chunks = [];

                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                
                mediaRecorder.onstop = () => {
                    // Al detener, crear el audio
                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                    audioUrl = window.URL.createObjectURL(blob);
                    grabacionAudio.src = audioUrl;
                    
                    // Apagar micrÃ³fono
                    streamMic.getTracks().forEach(track => track.stop());
                    
                    btnPlay.style.display = 'inline-block';
                    txtEstado.innerText = "Â¡GrabaciÃ³n lista!";
                };

                mediaRecorder.start();
                
                // UI
                btnGrabar.style.display = 'none';
                btnDetener.style.display = 'inline-block';
                btnPlay.style.display = 'none';
                txtEstado.innerText = "ğŸ”´ GRABANDO... (Â¡Canta!)";
                txtEstado.classList.add('parpadeo');

            } catch (err) {
                alert("Necesitas dar permiso al micrÃ³fono para grabar tu voz.");
                console.error(err);
            }
        };

        btnDetener.onclick = () => {
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                btnDetener.style.display = 'none';
                btnGrabar.style.display = 'inline-block';
                txtEstado.classList.remove('parpadeo');
            }
        };

        btnPlay.onclick = () => {
            txtEstado.innerText = "â–¶ï¸ Reproduciendo...";
            grabacionAudio.play();
            grabacionAudio.onended = () => txtEstado.innerText = "Â¡GrabaciÃ³n lista!";
        };

    </script>
</body>
</html>
