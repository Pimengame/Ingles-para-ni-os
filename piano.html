<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Piano Maestro Pro</title>
    <link rel="stylesheet" href="estilos.css">
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            overflow-x: hidden;
            user-select: none; /* Evita seleccionar texto al tocar r√°pido */
        }

        /* --- BOTONES SUPERIORES --- */
        .header-botones {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .btn-volver {
            position: relative; 
            margin: 0;
        }

        .btn-fullscreen {
            background: #263238;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
            border-bottom: 4px solid #000;
        }
        .btn-fullscreen:active { transform: translateY(4px); border-bottom-width: 0; }

        /* --- SELECTOR DE MODOS --- */
        .selector-modos {
            display: flex; justify-content: center; gap: 20px; 
            margin-top: 80px;
            margin-bottom: 25px;
        }
        .btn-modo {
            background: #fff; border: none; padding: 12px 25px; border-radius: 50px;
            font-family: 'Fredoka One', cursive; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 0 #ddd; transition: all 0.2s;
            opacity: 0.7; filter: grayscale(100%);
        }
        .btn-modo:active { transform: translateY(4px); box-shadow: none; }
        .btn-modo.activo {
            opacity: 1; filter: grayscale(0%); transform: scale(1.1);
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); z-index: 10;
        }
        #btn-modo-grabadora.activo { border: 2px solid #f44336; color: #d32f2f; }
        #btn-modo-clases.activo { border: 2px solid #2196f3; color: #1565c0; }

        /* --- PANELES --- */
        .panel-canciones {
            display: none; justify-content: center; gap: 10px; flex-wrap: wrap;
            margin-bottom: 15px; animation: bajar 0.5s ease; width: 100%;
            max-width: 900px; margin-left: auto; margin-right: auto;
        }
        @keyframes bajar { from{opacity:0; transform:translateY(-10px);} to{opacity:1; transform:translateY(0);} }

        .btn-cancion {
            background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5);
            padding: 8px 15px; border-radius: 15px; cursor: pointer;
            font-family: 'Fredoka One', cursive; font-size: 1rem; transition: 0.2s;
            margin-bottom: 5px;
        }
        .btn-cancion:hover { background: white; color: #3f51b5; }
        .btn-cancion.activa { background: #ff4081; border-color: white; color: white; transform: scale(1.05); }

        /* BOT√ìN DE DEMO (NUEVO) */
        .btn-demo {
            display: inline-block;
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 0 #2e7d32;
            transition: all 0.2s;
            font-family: 'Varela Round', sans-serif;
            animation: aparecer 0.5s ease;
        }
        .btn-demo:active { transform: translateY(3px); box-shadow: none; }
        .btn-demo:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        @keyframes aparecer { from{opacity:0; transform:scale(0.8);} to{opacity:1; transform:scale(1);} }

        /* --- TECLAS GU√çA --- */
        .tecla-blanca.tecla-guia {
            background: #ffeb3b !important;
            box-shadow: 0 0 30px #ffeb3b, inset 0 -5px 10px rgba(0,0,0,0.1) !important;
            z-index: 50; animation: latido 1s infinite; border-color: #fdd835;
        }
        .tecla-negra.tecla-guia {
            background: #ffeb3b !important;
            box-shadow: 0 0 30px #ffeb3b !important;
            z-index: 100; animation: latido 1s infinite; border-bottom-color: #f9a825;
        }
        @keyframes latido { 0%{transform:scale(1);} 50%{transform:scale(1.02) translateY(2px);} 100%{transform:scale(1);} }

        /* --- MUEBLE PIANO --- */
        .mueble-piano {
            overflow: hidden; 
            padding: 0 0 20px 0; 
            position: relative;
            max-width: 100%;
        }

        .tira-roja {
            height: 15px; background: #b71c1c; margin-bottom: 0; width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 20; position: relative;
        }

        .contenedor-teclas {
            display: flex;
            justify-content: center;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 20px;
            margin: 0 auto;
            background: rgba(0,0,0,0.2);
            border-top: 5px solid rgba(0,0,0,0.3);
            scrollbar-width: thin;
            scrollbar-color: #29b6f6 transparent;
            -webkit-overflow-scrolling: touch;
        }
        
        @media (max-width: 900px) {
            .contenedor-teclas { justify-content: flex-start; }
        }

        .aviso-scroll {
            display: none;
            color: #666;
            font-size: 0.9rem;
            margin-top: -10px;
            margin-bottom: 10px;
            font-family: 'Varela Round';
            animation: flotarTexto 2s infinite;
        }
        @media (max-width: 800px) { .aviso-scroll { display: block; } }
        @keyframes flotarTexto { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-3px);} }

    </style>
</head>
<body>

    <div class="header-botones">
        <a href="index.html" class="btn-volver">‚¨Ö Volver</a>
        <button class="btn-fullscreen" onclick="togglePantallaCompleta()" title="Pantalla Completa">‚õ∂</button>
    </div>

    <h1 style="margin-top: 10px;">üéπ Piano M√°gico</h1>

    <div class="selector-modos">
        <button id="btn-modo-grabadora" class="btn-modo activo" onclick="cambiarModo('grabadora')">
            üéôÔ∏è Estudio
        </button>
        <button id="btn-modo-clases" class="btn-modo" onclick="cambiarModo('clases')">
            üéì Escuela
        </button>
    </div>

    <div class="aviso-scroll">‚ÜîÔ∏è Desliza el piano para ver m√°s teclas ‚ÜîÔ∏è</div>

    <div class="mueble-piano">
        <div class="tira-roja"></div>

        <div id="panel-grabadora" class="panel-control-piano">
            <button id="btn-grabar" class="btn-rec btn-grabar" title="Grabar">üî¥</button>
            <button id="btn-detener" class="btn-rec btn-stop" title="Detener" style="display:none;">‚¨õ</button>
            <button id="btn-reproducir" class="btn-rec btn-play" title="Escuchar" style="display:none;">‚ñ∂Ô∏è</button>
            <div id="estado-grabacion" style="color:white; font-family:'Varela Round'; font-weight:bold; font-size:1.2rem;">
                ¬°Toca y Canta! üéµ
            </div>
        </div>

        <div id="panel-clases" class="panel-canciones">
            <div style="width: 100%; text-align: center; color: white; margin-bottom: 8px; font-family:'Varela Round'; opacity:0.8;">
                üëá Elige una canci√≥n:
            </div>
            <button class="btn-cancion" onclick="iniciarClase('estrellita', this)">üåü Estrellita</button>
            <button class="btn-cancion" onclick="iniciarClase('cumple', this)">üéÇ Cumplea√±os</button>
            <button class="btn-cancion" onclick="iniciarClase('himno', this)">üéº Alegr√≠a</button>
            <button class="btn-cancion" onclick="iniciarClase('tiburon', this)">ü¶à Tibur√≥n</button>
            <button class="btn-cancion" onclick="iniciarClase('recuerdame', this)">üé∏ Recu√©rdame</button>
            <button class="btn-cancion" onclick="iniciarClase('aladdin', this)">üßû‚Äç‚ôÇÔ∏è Un Mundo Ideal</button>
            <button class="btn-cancion" onclick="iniciarClase('dragonball', this)">üêâ Dragon Ball</button>
            <button class="btn-cancion" onclick="iniciarClase('slamdunk', this)">üèÄ Slam Dunk</button>
            
            <div id="area-mensajes" style="width: 100%; text-align: center; margin-top: 15px;">
                <div id="mensaje-clase" style="color: #ffeb3b; font-size: 1.4rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>
                <div id="contenedor-demo"></div> </div>
        </div>

        <div class="contenedor-teclas" id="miPiano">
            </div>
    </div>

    <script src="motor.js"></script>

    <script>
        // ==========================================
        // 1. CONFIGURACI√ìN DE AUDIO
        // ==========================================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        const contextoPiano = new AudioContext();
        const masterGain = contextoPiano.createGain();
        masterGain.gain.value = 0.8;
        masterGain.connect(contextoPiano.destination);
        const destinoGrabacion = contextoPiano.createMediaStreamDestination();

        let mediaRecorder;
        let chunks = [];
        let grabacionAudio = new Audio();
        let grabando = false;
        
        // Variables para la clase y demo
        let modoActual = 'grabadora';
        let cancionActual = [];
        let indiceNota = 0;
        let notaEsperada = null;
        let timeoutsDemo = []; // Para controlar la reproducci√≥n autom√°tica

        // ==========================================
        // 2. DEFINICI√ìN DE NOTAS
        // ==========================================
        const notas = [
            { id: "c3", nota: "Do", tipo: "b", freq: 130.81 }, { id: "cs3", nota: "", tipo: "n", freq: 138.59 },
            { id: "d3", nota: "Re", tipo: "b", freq: 146.83 }, { id: "ds3", nota: "", tipo: "n", freq: 155.56 },
            { id: "e3", nota: "Mi", tipo: "b", freq: 164.81 },
            { id: "f3", nota: "Fa", tipo: "b", freq: 174.61 }, { id: "fs3", nota: "", tipo: "n", freq: 185.00 },
            { id: "g3", nota: "Sol", tipo: "b", freq: 196.00 }, { id: "gs3", nota: "", tipo: "n", freq: 207.65 },
            { id: "a3", nota: "La", tipo: "b", freq: 220.00 }, { id: "as3", nota: "", tipo: "n", freq: 233.08 },
            { id: "b3", nota: "Si", tipo: "b", freq: 246.94 },

            { id: "c4", nota: "Do", tipo: "b", freq: 261.63 }, { id: "cs4", nota: "", tipo: "n", freq: 277.18 },
            { id: "d4", nota: "Re", tipo: "b", freq: 293.66 }, { id: "ds4", nota: "", tipo: "n", freq: 311.13 },
            { id: "e4", nota: "Mi", tipo: "b", freq: 329.63 },
            { id: "f4", nota: "Fa", tipo: "b", freq: 349.23 }, { id: "fs4", nota: "", tipo: "n", freq: 369.99 },
            { id: "g4", nota: "Sol", tipo: "b", freq: 392.00 }, { id: "gs4", nota: "", tipo: "n", freq: 415.30 },
            { id: "a4", nota: "La", tipo: "b", freq: 440.00 }, { id: "as4", nota: "", tipo: "n", freq: 466.16 },
            { id: "b4", nota: "Si", tipo: "b", freq: 493.88 },

            { id: "c5", nota: "Do", tipo: "b", freq: 523.25 }, { id: "cs5", nota: "", tipo: "n", freq: 554.37 },
            { id: "d5", nota: "Re", tipo: "b", freq: 587.33 }, { id: "ds5", nota: "", tipo: "n", freq: 622.25 },
            { id: "e5", nota: "Mi", tipo: "b", freq: 659.25 }
        ];

        const canciones = {
            'estrellita': ['c4','c4','g4','g4','a4','a4','g4','f4','f4','e4','e4','d4','d4','c4','g4','g4','f4','f4','e4','e4','d4','g4','g4','f4','f4','e4','e4','d4','c4','c4','g4','g4','a4','a4','g4','f4','f4','e4','e4','d4','d4','c4'],
            'cumple': ['c4','c4','d4','c4','f4','e4','c4','c4','d4','c4','g4','f4','c4','c4','c5','a4','f4','e4','d4','as4','as4','a4','f4','g4','f4'],
            'himno': ['e4','e4','f4','g4','g4','f4','e4','d4','c4','c4','d4','e4','e4','d4','d4','e4','e4','f4','g4','g4','f4','e4','d4','c4','c4','d4','e4','d4','c4','c4','d4','d4','e4','c4','d4','e4','f4','e4','c4','d4','e4','f4','e4','d4','c4','d4','g3'],
            'tiburon': ['d4','e4','g4','g4','g4','g4','g4','g4','d4','e4','g4','g4','g4','g4','g4','g4','d4','e4','g4','g4','g4','g4','g4','g4','g4','g4','f4'],
            'recuerdame': ['c4','e4','c4','c4','e4','c4','g3','e4','c4','e4','c4','e4','g4','f4','e4','d4','d4','e4','f4','e4','d4','c4','g3','a3','b3','c4','c4','c5','b4','a4','g4','f4','e4','f4','g4','f4','e4','d4','c4','e4','c4','c4','e4','c4','g3','e4','c4','e4','c4','e4','g4','f4','e4','d4','c4','c5','b4','c5','a4','a4','b4','a4','g4','f4','e4','f4','e4','f4','e4','d4','c4','c4','e4','c4'],
            'dragonball': ['g4','g4','e4','f4','g4','a4','g4','f4','e4','d4','e4','e4','c4','d4','e4','f4','e4','d4','c4','b3','a3','a3','a3','c4','a3','g3','c4','d4','e4','f4','e4','d4','c4','d4','c5','c5','c5','c5','c5','as4','gs4','as4','c5','as4','as4','as4','gs4','g4','g4','f4','f4','g4','ds4','f4','g4'],
            'slamdunk': [
                // --- INTRO (Sintetizador) ---
                {nota:'c4', duracion:400}, {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, 
                {nota:'a4', duracion:200}, {nota:'f4', duracion:200}, {nota:'a4', duracion:200}, {nota:'c5', duracion:600},
                // Bajada r√°pida
                {nota:'as4', duracion:150}, {nota:'a4', duracion:150}, {nota:'g4', duracion:150}, {nota:'f4', duracion:150},
                
                // Repetici√≥n subida
                {nota:'c4', duracion:400}, {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, 
                {nota:'a4', duracion:200}, {nota:'f4', duracion:200}, {nota:'a4', duracion:200}, {nota:'c5', duracion:600},
                // Final Intro
                {nota:'d5', duracion:200}, {nota:'c5', duracion:200}, {nota:'a4', duracion:200}, {nota:'g4', duracion:200}, {nota:'f4', duracion:800},

                // --- VERSO: "Brillante resplandor..." ---
                {nota:'f4', duracion:200}, {nota:'f4', duracion:200}, // Bri-llan
                {nota:'g4', duracion:200}, {nota:'a4', duracion:400}, // te-res
                {nota:'a4', duracion:200}, {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, // plan-dor-hay
                {nota:'d4', duracion:200}, {nota:'c4', duracion:600}, // a-qu√≠

                // "Cuando vas corriendo..."
                {nota:'f4', duracion:200}, {nota:'f4', duracion:200}, // Cuan-do
                {nota:'g4', duracion:200}, {nota:'a4', duracion:200}, // vas-co
                {nota:'c4', duracion:200}, {nota:'d4', duracion:200}, // rrien-do
                {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, {nota:'a4', duracion:200}, {nota:'g4', duracion:600}, // por-la-ciu-dad

                // "Y ya verte llegar"
                {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, // Y-ya
                {nota:'a4', duracion:400}, {nota:'as4', duracion:400}, // ver-te
                {nota:'a4', duracion:200}, {nota:'g4', duracion:600}, // lle-gar

                // --- PUENTE: "Y sin pensarlo..." ---
                {nota:'a4', duracion:300}, {nota:'a4', duracion:300}, // Y-sin
                {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, {nota:'d4', duracion:600}, // pen-sar-lo

                // "Me qued√© mirando"
                {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, // Me-que
                {nota:'a4', duracion:200}, {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, {nota:'g4', duracion:400}, // d√©-mi-ran-do

                // "Tu rostro infantil"
                {nota:'as4', duracion:200}, {nota:'a4', duracion:200}, {nota:'g4', duracion:200}, // Tu-ros-tro
                {nota:'a4', duracion:200}, {nota:'a4', duracion:200}, {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, {nota:'d4', duracion:400}, // in-fan-til

                // "Loco por ti" (Golpes fuertes)
                {nota:'c5', duracion:300}, {nota:'c5', duracion:300}, {nota:'c5', duracion:600}, // Lo-co-por-ti!

                // --- CORO EXPLOSIVO ---
                // "Quiero gritar te amo"
                {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, // Quie-ro
                {nota:'a4', duracion:200}, {nota:'as4', duracion:200}, // gri-tar
                {nota:'c5', duracion:400}, {nota:'d5', duracion:400}, {nota:'c5', duracion:800}, // te-a-mo

                // "Y que sepas que te quiero"
                {nota:'a4', duracion:200}, {nota:'f4', duracion:200}, // Y-que
                {nota:'g4', duracion:200}, {nota:'a4', duracion:200}, // se-pas
                {nota:'as4', duracion:200}, {nota:'a4', duracion:200}, // que-te
                {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, {nota:'g4', duracion:600}, // quie-ro

                // "Y romper esta barrera"
                {nota:'c4', duracion:200}, // Y
                {nota:'f4', duracion:200}, {nota:'g4', duracion:200}, // rom-per
                {nota:'a4', duracion:200}, {nota:'as4', duracion:200}, // es-ta
                {nota:'c5', duracion:200}, {nota:'d5', duracion:200}, // ba-rre
                {nota:'c5', duracion:400}, {nota:'a4', duracion:200}, {nota:'f4', duracion:200}, // ra...

                // "Para verte iluminar"
                {nota:'g4', duracion:200}, {nota:'a4', duracion:200}, // Pa-ra
                {nota:'as4', duracion:200}, {nota:'a4', duracion:200}, // ver-te
                {nota:'g4', duracion:200}, {nota:'f4', duracion:200}, // i-lu
                {nota:'e4', duracion:200}, {nota:'f4', duracion:800}, // mi-nar

                // "Mi amor..."
                {nota:'g4', duracion:400}, {nota:'f4', duracion:1000} // Mi-amor
            ],
            'aladdin': [
                // --- VERSO 1 (ALADD√çN): "Yo te quiero ense√±ar" ---
                {nota:'fs4', duracion:400}, {nota:'e4', duracion:200}, // Yo-te
                {nota:'g4', duracion:400}, {nota:'fs4', duracion:200}, // quie-ro
                {nota:'d4', duracion:400}, {nota:'a3', duracion:800}, // en-se-√±ar...

                // "Este mundo espl√©ndido"
                {nota:'fs4', duracion:400}, {nota:'e4', duracion:200}, // Es-te
                {nota:'g4', duracion:400}, {nota:'fs4', duracion:200}, // mun-do
                {nota:'d4', duracion:400}, {nota:'fs4', duracion:400}, {nota:'e4', duracion:1000}, // es-pl√©n-di-do

                // "Ven princesa y deja a tu coraz√≥n so√±ar"
                {nota:'e4', duracion:300}, {nota:'ds4', duracion:300}, // Ven-prin
                {nota:'fs4', duracion:300}, {nota:'e4', duracion:300}, // ce-sa
                {nota:'cs4', duracion:300}, {nota:'e4', duracion:300}, // y-de
                {nota:'d4', duracion:800}, // ja...
                {nota:'cs4', duracion:300}, {nota:'d4', duracion:300}, // a-tu
                {nota:'b3', duracion:300}, {nota:'cs4', duracion:300}, // co-ra
                {nota:'e4', duracion:400}, {nota:'d4', duracion:400}, {nota:'a3', duracion:1000}, // z√≥n-so-√±ar

                // --- VERSO 2 (JASM√çN): "Yo te puedo mostrar" ---
                {nota:'fs4', duracion:400}, {nota:'e4', duracion:200}, // Yo-te
                {nota:'g4', duracion:400}, {nota:'fs4', duracion:200}, // pue-do
                {nota:'d4', duracion:400}, {nota:'a3', duracion:800}, // mos-trar...

                // "Cosas maravillosas"
                {nota:'fs4', duracion:400}, {nota:'e4', duracion:200}, // Co-sas
                {nota:'g4', duracion:400}, {nota:'fs4', duracion:200}, // ma-ra
                {nota:'d4', duracion:400}, {nota:'fs4', duracion:400}, {nota:'e4', duracion:1000}, // vi-llo-sas

                // "Con la magia de mi alfombra..."
                {nota:'e4', duracion:300}, {nota:'ds4', duracion:300}, // Con-la
                {nota:'fs4', duracion:300}, {nota:'e4', duracion:300}, // ma-gia
                {nota:'cs4', duracion:300}, {nota:'e4', duracion:300}, // de-mi
                {nota:'d4', duracion:800}, // al...
                {nota:'cs4', duracion:300}, {nota:'d4', duracion:300}, // fom-bra
                {nota:'b3', duracion:300}, {nota:'cs4', duracion:300}, // va-mos
                {nota:'e4', duracion:400}, {nota:'d4', duracion:400}, // a-vo
                {nota:'d4', duracion:200}, // lar... (puente r√°pido)

                // --- CORO 1: "Un mundo ideal" ---
                {nota:'fs4', duracion:400}, {nota:'g4', duracion:400}, // Un-mun
                {nota:'b4', duracion:600}, {nota:'a4', duracion:1200}, // do-i-deal

                // "Un mundo en el que t√∫ y yo"
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Un-mun
                {nota:'b4', duracion:400}, {nota:'a4', duracion:400}, // do-en
                {nota:'e4', duracion:400}, {nota:'g4', duracion:400}, {nota:'fs4', duracion:1000}, // que-t√∫-y-yo

                // "Podamos decidir"
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Po-da
                {nota:'a4', duracion:400}, {nota:'cs5', duracion:400}, // mos-de
                {nota:'b4', duracion:600}, {nota:'a4', duracion:1000}, // ci-dir

                // "Sin nadie que nos diga no"
                {nota:'d5', duracion:400}, {nota:'cs5', duracion:400}, // Sin-na
                {nota:'d5', duracion:400}, {nota:'a4', duracion:1000}, // die-que...
                
                // "O a d√≥nde ir"
                {nota:'d4', duracion:300}, {nota:'fs4', duracion:300}, // O-a
                {nota:'e4', duracion:300}, {nota:'d4', duracion:300}, // don-de
                {nota:'b3', duracion:400}, {nota:'d4', duracion:400}, {nota:'e4', duracion:1000}, // ir...

                // --- PUENTE (JASM√çN): "Fabulosa visi√≥n" ---
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Fa-bu
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // lo-sa
                {nota:'a4', duracion:400}, {nota:'d4', duracion:1000}, // vi-si√≥n

                // "Sentimiento divino"
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Sen-ti
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // mien-to
                {nota:'a4', duracion:400}, {nota:'d4', duracion:1000}, // di-vi-no

                // "Baja y sube y vuela..."
                {nota:'g4', duracion:200}, {nota:'fs4', duracion:200}, // Ba-ja
                {nota:'e4', duracion:200}, {nota:'d4', duracion:200}, // y-su
                {nota:'a3', duracion:200}, {nota:'d4', duracion:200}, {nota:'e4', duracion:1200}, // be-y-vue-la...

                // --- CORO FINAL (A D√öO) ---
                {nota:'fs4', duracion:400}, {nota:'g4', duracion:400}, // Un-mun
                {nota:'b4', duracion:600}, {nota:'a4', duracion:1200}, // do-i-deal

                // "Cada vuelta es sorpresa"
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Ca-da
                {nota:'b4', duracion:400}, {nota:'a4', duracion:400}, // vuel-ta
                {nota:'e4', duracion:400}, {nota:'g4', duracion:400}, {nota:'fs4', duracion:1000}, // es-sor-pre-sa

                // "Un horizonte nuevo abrir"
                {nota:'fs4', duracion:300}, {nota:'g4', duracion:300}, // Un-ho
                {nota:'a4', duracion:400}, {nota:'cs5', duracion:400}, // ri-zon
                {nota:'b4', duracion:600}, {nota:'a4', duracion:1000}, // te-a-brir

                // "Hay que seguir sin fin"
                {nota:'d5', duracion:400}, {nota:'cs5', duracion:400}, // Hay-que
                {nota:'d5', duracion:400}, {nota:'a4', duracion:1000}, // se-guir

                // "Hasta el conf√≠n"
                {nota:'d4', duracion:300}, {nota:'fs4', duracion:300}, // Has-ta
                {nota:'e4', duracion:300}, {nota:'d4', duracion:300}, // el-con
                {nota:'b3', duracion:400}, {nota:'d4', duracion:400}, {nota:'e4', duracion:1000}, // f√≠n...

                // "Juntos en un mundo ideal t√∫ y yo"
                {nota:'d4', duracion:300}, {nota:'fs4', duracion:300}, // Jun-tos
                {nota:'e4', duracion:300}, {nota:'d4', duracion:300}, // en-un
                {nota:'e4', duracion:300}, {nota:'fs4', duracion:300}, // mun-do
                {nota:'e4', duracion:300}, {nota:'d4', duracion:300}, // i-deal
                {nota:'cs4', duracion:400}, {nota:'d4', duracion:1500} // t√∫-y-yo...
            ],
        };

        const pianoContainer = document.getElementById('miPiano');
        let blancasCount = 0;
        const anchoBlanca = 60; 
        const anchoNegra = 40; 

        if (pianoContainer) {
            notas.forEach(item => {
                const tecla = document.createElement('div');
                tecla.id = 'tecla-' + item.id; 
                if (item.tipo === 'b') {
                    tecla.className = 'tecla-blanca';
                    tecla.innerText = item.nota;
                    pianoContainer.appendChild(tecla);
                    asignarEventos(tecla, item);
                    blancasCount++;
                } else {
                    tecla.className = 'tecla-negra';
                    const leftPos = (blancasCount * anchoBlanca) - (anchoNegra / 2); 
                    tecla.style.left = leftPos + 'px';
                    pianoContainer.appendChild(tecla);
                    asignarEventos(tecla, item);
                }
            });
            pianoContainer.style.width = (blancasCount * anchoBlanca) + 'px';
        }

        // ==========================================
        // 3. MOTOR DE SONIDO Y L√ìGICA DE DEMO
        // ==========================================
        function tocarNota(item, elemento) {
            if (contextoPiano.state === 'suspended') contextoPiano.resume();
            
            if(elemento.classList.contains('activa')) return;
            elemento.classList.add('activa');

            const osc = contextoPiano.createOscillator();
            const noteGain = contextoPiano.createGain();

            osc.type = 'triangle'; 
            osc.frequency.setValueAtTime(item.freq, contextoPiano.currentTime);

            noteGain.gain.setValueAtTime(0, contextoPiano.currentTime);
            noteGain.gain.linearRampToValueAtTime(0.5, contextoPiano.currentTime + 0.02);
            noteGain.gain.exponentialRampToValueAtTime(0.001, contextoPiano.currentTime + 1.5);

            noteGain.connect(masterGain);
            noteGain.connect(destinoGrabacion); 

            osc.connect(noteGain);
            osc.start();
            osc.stop(contextoPiano.currentTime + 1.5);
            elemento.oscilador = osc;

            // L√≥gica para modo clases
            if (modoActual === 'clases' && notaEsperada && timeoutsDemo.length === 0) {
                if (item.id === notaEsperada) {
                    indiceNota++;
                    iluminarSiguienteNota();
                }
            }
        }

        function soltarTecla(elemento) {
            setTimeout(() => elemento.classList.remove('activa'), 150);
            if (elemento.oscilador) {
                try { elemento.oscilador.stop(contextoPiano.currentTime + 0.1); } catch(e) {}
            }
        }

        // --- FUNCI√ìN PARA REPRODUCIR DEMO ---
// --- NUEVA FUNCI√ìN DE DEMO CON RITMO REAL ---
        function reproducirDemo() {
            detenerDemo(); 
            const btn = document.getElementById('btn-demo-play');
            if(btn) btn.innerText = "‚èπ Detener";

            let tiempoAcumulado = 0;

            cancionActual.forEach((item, index) => {
                // Detectar si es formato simple (solo texto) o formato complejo (con ritmo)
                const esComplejo = typeof item === 'object';
                const idNota = esComplejo ? item.nota : item;
                const duracion = esComplejo ? item.duracion : 500; // 500ms por defecto si no tiene ritmo

                const tiempo = setTimeout(() => {
                    const notaObj = notas.find(n => n.id === idNota);
                    const elemento = document.getElementById('tecla-' + idNota);
                    
                    if (notaObj && elemento) {
                        tocarNota(notaObj, elemento);
                        
                        // Soltar la tecla visualmente seg√∫n la duraci√≥n de la nota
                        // Le restamos un poquito (50ms) para que se note la separaci√≥n entre notas
                        setTimeout(() => soltarTecla(elemento), duracion - 50);
                    }

                    // Restaurar bot√≥n al final
                    if (index === cancionActual.length - 1) {
                        setTimeout(() => {
                            if(btn) btn.innerText = "üîä Escuchar melod√≠a";
                        }, duracion);
                    }

                }, tiempoAcumulado);
                
                timeoutsDemo.push(tiempo);
                tiempoAcumulado += duracion; // Sumamos el tiempo para la siguiente nota
            });
        }
        function detenerDemo() {
            timeoutsDemo.forEach(t => clearTimeout(t));
            timeoutsDemo = [];
            
            // Limpiar teclas que se hayan quedado pegadas visualmente
            document.querySelectorAll('.activa').forEach(el => {
                el.classList.remove('activa');
                // Intentar detener osciladores si est√°n en el DOM (truco r√°pido)
                if(el.oscilador) { try{el.oscilador.stop();}catch(e){} }
            });

            const btn = document.getElementById('btn-demo-play');
            if(btn) btn.innerText = "üîä Escuchar melod√≠a";
            
            // Reiniciar gu√≠a visual
            if(modoActual === 'clases') iluminarSiguienteNota();
        }

        function asignarEventos(tecla, item) {
            const iniciar = (e) => { 
                if(e.type === 'mousedown' && e.buttons !== 1) return;
                // SI EL USUARIO TOCA, DETENER DEMO
                if(timeoutsDemo.length > 0) detenerDemo();
                tocarNota(item, tecla); 
            };
            const terminar = (e) => { soltarTecla(tecla); };

            tecla.addEventListener('mousedown', iniciar);
            tecla.addEventListener('touchstart', (e) => { e.preventDefault(); iniciar(e); }); // Peque√±o fix para touch
            tecla.addEventListener('mouseup', terminar);
            tecla.addEventListener('mouseleave', terminar);
            tecla.addEventListener('touchend', terminar);
        }

        function iniciarClase(nombreCancion, btn) {
            detenerDemo(); // Detener cualquier sonido anterior
            document.querySelectorAll('.btn-cancion').forEach(b => b.classList.remove('activa'));
            if(btn) btn.classList.add('activa');

            document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));
            cancionActual = canciones[nombreCancion];
            indiceNota = 0;
            document.getElementById('mensaje-clase').innerText = "¬°Sigue la tecla amarilla!";
            
            // CREAR BOT√ìN DE DEMO DIN√ÅMICAMENTE
            const contenedorDemo = document.getElementById('contenedor-demo');
            contenedorDemo.innerHTML = `<button id="btn-demo-play" class="btn-demo" onclick="toggleDemo()">üîä Escuchar melod√≠a</button>`;
            
            centrarPianoEnDoCentral();
            iluminarSiguienteNota();
        }

        function toggleDemo() {
            if(timeoutsDemo.length > 0) {
                detenerDemo();
            } else {
                reproducirDemo();
            }
        }

        function iluminarSiguienteNota() {
            document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));

            // No iluminar si est√° sonando la demo para no confundir
            if(timeoutsDemo.length > 0) return;

            if (indiceNota < cancionActual.length) {
                notaEsperada = cancionActual[indiceNota];
                const tecla = document.getElementById('tecla-' + notaEsperada);
                if (tecla) tecla.classList.add('tecla-guia');
            } else {
                notaEsperada = null;
                document.getElementById('mensaje-clase').innerHTML = "¬°FELICIDADES! üéâ";
                document.getElementById('contenedor-demo').innerHTML = ""; // Quitar bot√≥n al terminar
                
                // Efecto victoria simple
                if(typeof lanzarConfeti === 'function') lanzarConfeti();
                // Sonido victoria simple
                const osc = contextoPiano.createOscillator();
                osc.type = 'sine';
                osc.frequency.setValueAtTime(523.25, contextoPiano.currentTime); // Do5
                osc.frequency.setValueAtTime(659.25, contextoPiano.currentTime + 0.1); // Mi5
                osc.connect(masterGain);
                osc.start(); osc.stop(contextoPiano.currentTime + 0.3);
            }
        }

        function cambiarModo(modo) {
            detenerDemo();
            modoActual = modo;
            document.getElementById('btn-modo-grabadora').classList.toggle('activo', modo === 'grabadora');
            document.getElementById('btn-modo-clases').classList.toggle('activo', modo === 'clases');
            const pGrab = document.getElementById('panel-grabadora');
            const pClas = document.getElementById('panel-clases');

            if (modo === 'grabadora') {
                pGrab.style.display = 'flex'; pClas.style.display = 'none';
                document.querySelectorAll('.tecla-guia').forEach(t => t.classList.remove('tecla-guia'));
                notaEsperada = null;
            } else {
                pGrab.style.display = 'none'; pClas.style.display = 'flex';
                document.getElementById('mensaje-clase').innerText = "Selecciona una canci√≥n";
                document.getElementById('contenedor-demo').innerHTML = "";
                centrarPianoEnDoCentral();
            }
        }

        function centrarPianoEnDoCentral() {
            const doCentral = document.getElementById('tecla-c4');
            if(doCentral) {
                doCentral.scrollIntoView({behavior: "smooth", block: "nearest", inline: "center"});
            }
        }
        
        // PANTALLA COMPLETA
        function togglePantallaCompleta() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => { alert(`Error: ${err.message}`); });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        window.addEventListener('load', () => { setTimeout(centrarPianoEnDoCentral, 500); });

        // GRABACI√ìN
        const btnGrabar = document.getElementById('btn-grabar');
        const btnDetener = document.getElementById('btn-detener');
        const btnPlay = document.getElementById('btn-reproducir');
        const txtEstado = document.getElementById('estado-grabacion');

        btnGrabar.onclick = async () => {
            if (contextoPiano.state === 'suspended') await contextoPiano.resume();
            try {
                const streamMic = await navigator.mediaDevices.getUserMedia({audio: true});
                const sourceMic = contextoPiano.createMediaStreamSource(streamMic);
                sourceMic.connect(destinoGrabacion);
                mediaRecorder = new MediaRecorder(destinoGrabacion.stream);
                chunks = [];
                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { 'type' : 'audio/ogg; codecs=opus' });
                    grabacionAudio.src = window.URL.createObjectURL(blob);
                    streamMic.getTracks().forEach(track => track.stop());
                    btnPlay.style.display = 'inline-block'; txtEstado.innerText = "¬°Grabado! üé§";
                    grabando = false;
                };
                mediaRecorder.start(); grabando = true;
                btnGrabar.style.display = 'none'; btnDetener.style.display = 'inline-block'; btnPlay.style.display = 'none';
                txtEstado.innerText = "üî¥ Grabando...";
            } catch (err) { alert("Necesito micr√≥fono para grabar."); }
        };
        btnDetener.onclick = () => { if(mediaRecorder && grabando) { mediaRecorder.stop(); btnDetener.style.display = 'none'; btnGrabar.style.display = 'inline-block'; } };
        btnPlay.onclick = () => { txtEstado.innerText = "‚ñ∂Ô∏è Reproduciendo..."; grabacionAudio.play(); grabacionAudio.onended = () => txtEstado.innerText = "¬°Grabado! üé§"; };

    </script>
</body>
</html>








